
## 1. Transactional vs. Eventual Consistency โ๏ธ

### A. Transactional Consistency (All or Nothing)

ูุฐุง ูู ุงูููุฌ ุงูุฐู ููุง ูุณุชุฎุฏูู ุณุงุจูุงู ูุน ุงูู `UnitOfWork`.

- **ุงููุจุฏุฃ:** ูู ุงูุชุบููุฑุงุช (ุญุฐู ุงูุฃุฏููุ ุญุฐู ุงูุฌููุงุชุ ุญุฐู ุงูุงุดุชุฑุงูุงุช) ุชุญุฏุซ ูู "ุตูุฏูู ูุงุญุฏ".
    
    - ุฅูุง ุฃู ุชูุฌุญ ูููุง ููุชู ุงูุญูุธ.
        
    - ุฃู ุชูุดู ูููุง ููุญุฏุซ Rollback.
        
- **ุงูุฅูุฌุงุจูุงุช:**
    
    - **ุณูููุฉ ุงูููู (Low Cognitive Load):** ูู ุดูุก ููุชูุจ ุฃูุงูู ุฎุทูุฉ ุจุฎุทูุฉ.
        
    - **ุจูุงูุงุช ูุชุณูุฉ ููุฑุงู:** ูุง ุชูุฌุฏ ูุญุธุฉ ูููู ูููุง ุงูุฃุฏูู ูุญุฐููุงู ูุงูุฌููุงุช ูุง ุฒุงูุช ููุฌูุฏุฉ.
        
- **ุงูุณูุจูุงุช:**
    
    - **ุงูุฃุฏุงุก (Performance):** ุงููุณุชุฎุฏู (Client) ูุฌุจ ุฃู ููุชุธุฑ ุญุชู ุชูุชูู ูู ูุฐู ุงูุนูููุงุช (ุจูุง ูููุง ุฅุฑุณุงู ุงูุฅููููุงุช) ููุญุตู ุนูู ุฑุฏ.
        
    - **ูุญุฏูุฏูุฉ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:** ูุง ูููู ุนูู Retry ูุนูููุฉ ุทูููุฉ ุฃุซูุงุก ุงูุชุธุงุฑ ุงููุณุชุฎุฏู.
        
    - **ุตุนูุจุฉ ุงูุชูุณุน (Scalability):** ูู ุงูุฎุฏูุงุช ูุฑุชุจุทุฉ ุจุจุนุถูุง ุจููุฉ.
        

### B. Eventual Consistency (Divided Processing)

ูุฐุง ูู ุงูููุฌ ุงูุฐู ูุณุนู ุฅููู ุจุงุณุชุฎุฏุงู **Domain Events**.

- **ุงููุจุฏุฃ:** ุชูุณูู ุงูุนูููุงุช ุฅูู "ูุทุน ุตุบูุฑุฉ".
    
    - ูููู ุจุงูุญุฏ ุงูุฃุฏูู ุงูุถุฑูุฑู ููุฑุงู (ุญุฐู ุงูุงุดุชุฑุงู ูู ุงูุฃุฏูู) ููุฑุฏ ุนูู ุงููุณุชุฎุฏู.
        
    - ุจุงูู ุงูุนูููุงุช (ุญุฐู ุงูุฌููุงุชุ ุฅุฑุณุงู ุฅููููุงุช) ุชุญุฏุซ ูุงุญูุงู ูู ุงูุฎูููุฉ.
        
- **ุงูุฅูุฌุงุจูุงุช:**
    
    - **ุณุฑุนุฉ ุตุงุฑูุฎูุฉ (Blazing Fast):** ุงููุณุชุฎุฏู ูุง ููุชุธุฑ ุงูุนูููุงุช ุงูุฌุงูุจูุฉ.
        
    - **ูุฑููุฉ ูู ุงูุฃุฎุทุงุก:** ูููู ุฅุนุงุฏุฉ ูุญุงููุฉ ุญุฐู ุงูุฌููุงุช 10 ูุฑุงุช ูู ุงูุฎูููุฉ ุฏูู ุฃู ูุดุนุฑ ุงููุณุชุฎุฏู ุจุดูุก.
        
    - **ุฅุนุงุฏุฉ ุงูุงุณุชุฎุฏุงู (Composability):** ูู ูุงู ูุฏููุง ููุทู ูุญุฐู ุงูุฌููุงุช ุนูุฏ ุญุฐู ุงุดุชุฑุงูุ ูููู ุงุณุชุฎุฏุงูู ุฃูุถุงู ุนูุฏ ุญุฐู ุฃุฏูู.
        
- **ุงูุณูุจูุงุช:**
    
    - **ุชุนููุฏ ุฃุนูู (Higher Complexity):** ุชุชุจุน ุงูููุฏ ุฃุตุนุจ ูุฃูู ููุฒุน.
        
    - **ุนุฏู ุงูุงุชุณุงู ุงููุคูุช:** ูุฏ ูููู ุงูุงุดุชุฑุงู ูุญุฐููุงู ูุงูุฌููุงุช ูุง ุชุฒุงู ููุฌูุฏุฉ ูุจุถุน ุซูุงูู.
        

---

## 2. The "Common" (But Wrong) Approach in .NET ๐ซ

ููุงู ุทุฑููุฉ ุดุงุฆุนุฉ ุฌุฏุงู ูุชูููุฐ Domain Events ูู .NET ุจุงุณุชุฎุฏุงู EF Core Interceptorsุ ููู ุงููุญุงุถุฑ ูุฑู ุฃููุง **ุชูุณุฏ ุงูุบุฑุถ ุงูุฃุณุงุณู** ูู ุงูู Domain Events.

### ููู ุชุนูู ุงูุทุฑููุฉ ุงูุดุงุฆุนุฉุ

1. ูุณุชุฎุฏู `Interceptor` ุฃู `Override SaveChanges` ูู ุงูู `DbContext`.
    
2. **ูุจู** ุงูุญูุธ ูู ุงูุฏุงุชุงุจูุณ:
    
    - ูุฌูุจ ูู ุงูู Entities ุงูุชู ุชุบูุฑุช.
        
    - ูุณุญุจ ูููุง ุงูู Domain Events.
        
    - ูููู ุจูุดุฑูุง (`Publish`) ุจุงุณุชุฎุฏุงู MediatR.
        
3. ูุชู ุชูููุฐ ุงูู Handlers (ุญุฐู ุงูุฌููุงุช ูุซูุงู).
    
4. ูุฐู ุงูู Handlers ุชููู ุจุฏูุฑูุง ุจุงุณุชุฏุนุงุก `SaveChanges`ุ ููุง ูุฏ ูุทูู ุฃุญุฏุงุซุงู ุฌุฏูุฏุฉ (Recursive).
    
5. ุฃุฎูุฑุงูุ ูุชู ุญูุธ ุงูุชุบููุฑุงุช ุงูุฃุตููุฉ.
    

### ููุงุฐุง ูุฐู ุงูุทุฑููุฉ "ุฎุงุทุฆุฉ"ุ

1. **ุงููุณุชุฎุฏู ูุง ูุฒุงู ููุชุธุฑ! โณ**
    
    - ุจูุง ุฃููุง ููุดุฑ ุงูุฃุญุฏุงุซ ูููุชุธุฑ ุงูุชูุงุก ุงูู Handlers _ูุจู_ ุฅุฑุณุงู ุงูุฑุฏุ ููุญู ุนูููุงู ุนุฏูุง ูู **Transactional Consistency** ูููู ุจููุฏ ุฃูุซุฑ ุชุนููุฏุงู ูููุฒุนุงู ุนูู ุนุฏุฉ ูููุงุช! ูู ููุณุจ ุณุฑุนุฉ ุงูุฃุฏุงุก.
        
2. **ูุฎุงููุฉ ุงููุจุฏุฃ ุงููุธุฑู:**
    
    - ุงูู Domain Event ููุชุฑุถ ุฃู ููุซู ุดูุฆุงู "ุญุฏุซ ูุชู ุญูุธู" (Something happened). ููููุง ููุง ููุดุฑู _ูุจู_ ุงูุญูุธ. ูู ูุดู ุงูุญูุธ ูู ุงููุญุธุฉ ุงูุฃุฎูุฑุฉุ ูููู ูุฏ ุฃุทูููุง ุฃุญุฏุงุซุงู ูุงุฐุจุฉ.
        
3. **ุงูุชุนููุฏ ุงููุชุฏุงุฎู (Recursive Complexity):**
    
    - ุงูู Handlers ุชูุงุฏู SaveChangesุ ุงูุชู ุชูุดุฑ ุฃุญุฏุงุซุงูุ ุงูุชู ุชูุงุฏู SaveChanges... ููุง ูุฌุนู ุชุชุจุน ุงูุฃุฎุทุงุก ูุงุจูุณุงู.
        

---

## 3. The Better Approach (Outbox Pattern Preview) ๐ก

ุงูุญู ุงูุฐู ุณูุนุชูุฏู ูุงุญูุงู (ูู ุงูุฃูุณุงู ุงููุงุฏูุฉ) ูุนุงูุฌ ูุฐู ุงููุดุงูู ุฌุฐุฑูุงู:

- ุนูุฏูุง ูุญูุธ ุงูุชุบููุฑุงุชุ ูุญูุธ ูุนูุง ุงูุฃุญุฏุงุซ ูู ุฌุฏูู ุฎุงุต (Outbox Table) ูู **ููุณ ุงูุชุฑุงูุฒูุดู**.
    
- ุงููุณุชุฎุฏู ูุญุตู ุนูู ุฑุฏ ููุฑู.
    
- **ุนูููุฉ ูููุตูุฉ (Background Job)** ุชููู ุจูุฑุงุกุฉ ุงูุฃุญุฏุงุซ ูู ุงูุฌุฏูู ููุดุฑูุง ูุงุญูุงู.
    

ูุฐุง ูุถูู:

1. ุงูุณุฑุนุฉ ูููุณุชุฎุฏู.
    
2. ุนุฏู ุถูุงุน ุงูุฃุญุฏุงุซ (ูุฃููุง ุญูุธุช ูู ุงูุฏุงุชุงุจูุณ).
    
3. ูุตู ุญูููู ุจูู ุงูุนูููุฉ ุงูุฃุณุงุณูุฉ ูุงูุนูููุงุช ุงูุฌุงูุจูุฉ.
    

>[!Tip]
>END




---

# Deep Dive: Implementing True Eventual Consistency - Part 1

ูู ูุฐุง ุงููุณูุ ูุทุฑุญ ุงููุญุงุถุฑ ุญูุงู ูุจุชูุฑุงู ููุดููุฉ ุงูุชุธุงุฑ ุงููุณุชุฎุฏู (ุงูุชู ูุงูุดูุงูุง ุณุงุจูุงู) ุจุงุณุชุฎุฏุงู ุชูููุฉ **"Queue & Middleware"**. ูุฐุง ุงูููุฌ ูุถูู ุฃู ุงููุณุชุฎุฏู ูุญุตู ุนูู ุงูุงุณุชุฌุงุจุฉ ููุฑุงูุ ุจูููุง ูุชู ุชูููุฐ ุงูู Handlers ูุงุญูุงู ูู ุงูุฎูููุฉ (ูู ููุณ ุงูุทูุจ ูููู ุจุนุฏ ุงูุฑุฏุ ุฃู ูุจู ุฅุบูุงู ุงูุงุชุตุงู ุจูููู).

---

## 1. The Strategy: "Park & Process" ๐ฟ๏ธโก๏ธโถ๏ธ

ุจุฏูุงู ูู ูุดุฑ ุงูุฃุญุฏุงุซ ููุฑุงู ุนูุฏ ุงูุญูุธุ ุณูููู ุจู "ุฑูููุง" (Parking) ุฌุงูุจุงู ูู ุทุงุจูุฑ (Queue)ุ ููุนุงูุฌูุง ูุงุญูุงู.

### ุงูุฎุทูุงุช:

1. **ูู `SaveChanges`:** ูุณุญุจ ุงูุฃุญุฏุงุซ ูู ุงูู Entities ููุฎุฒููุง ูู `HttpContext.Items` (ูุฎุฒู ูุคูุช ุฎุงุต ุจุงูุทูุจ ุงูุญุงูู).
    
2. **ุฅุชูุงู ุงูุญูุธ:** ูุญูุธ ุงูุชุบููุฑุงุช ุงูุฃุตููุฉ (ุญุฐู ุงูุฃุฏูู) ููููู ุงูุงุชุตุงู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช.
    
3. **ุงูุฑุฏ ุนูู ุงููุณุชุฎุฏู:** (ูุธุฑูุงูุ ุงูููุฏููููุฑ ุณูุนูู ุจุนุฏ ุงูุฑุฏ ุฃู ูู ููุงูุชู).
    
4. **ูู Middleware ุฎุงุต:** ููุฑุฃ ุงูุฃุญุฏุงุซ ูู ุงูู `HttpContext` ูููุดุฑูุง ูุงุญุฏุงู ุชูู ุงูุขุฎุฑ.
    

---

## 2. Preparing the Entity Base Class ๐๏ธ

ูุญุชุงุฌ ูุทุฑููุฉ ูุณุญุจ ุงูุฃุญุฏุงุซ ูู ุงูู Entity ููุณุญูุง ุญุชู ูุง ุชุชูุฑุฑ.

ูู `Domain/Common/Entity.cs`:



```csharp
public abstract class Entity
{
    private readonly List<IDomainEvent> _domainEvents = new();
    
    // ุฏุงูุฉ ุฌุฏูุฏุฉ ูุณุญุจ ุงูุฃุญุฏุงุซ ููุณุญ ุงููุงุฆูุฉ
    public List<IDomainEvent> PopDomainEvents()
    {
        var copy = _domainEvents.ToList(); // ุฎุฐ ูุณุฎุฉ
        _domainEvents.Clear();             // ุงูุณุญ ุงูุฃุตู
        return copy;                       // ุฃุฑุฌุน ุงููุณุฎุฉ
    }
}
```





---

## 3. Implementing the Queue Logic in `DbContext` ๐๏ธ

ุณูููู ุจุชุนุฏูู `GymManagementDbContext` ูุงุนุชุฑุงุถ ุนูููุฉ ุงูุญูุธ ูุชุฎุฒูู ุงูุฃุญุฏุงุซ ุจุฏูุงู ูู ูุดุฑูุง.

### ุงูุฎุทูุงุช ูู ุงูููุฏ:

1. **Inject `IHttpContextAccessor`:** ููุชููู ูู ุงููุตูู ูู `HttpContext.Items`.
    
2. **Override `SaveChangesAsync`:**
    



```csharp
public override async Task<int> SaveChangesAsync(CancellationToken cancellationToken = default)
{
    // 1. Fetch Domain Events from Tracker
    var domainEvents = ChangeTracker.Entries<Entity>()
        .Select(entry => entry.Entity.PopDomainEvents())
        .SelectMany(x => x) // Flatten list of lists
        .ToList();

    // 2. Add to Queue if any exist
    if (IsUserWaitingOnline()) // Check if HttpContext is available
    {
        AddDomainEventsToOfflineProcessingQueue(domainEvents);
    }

    // 3. Save Changes to DB
    return await base.SaveChangesAsync(cancellationToken);
}
```

### ููุทู ุงูุทุงุจูุฑ (`AddDomainEventsToOfflineProcessingQueue`):

ููุง ูููู ุงูุณุฑ. ูุญู ูุง ูุฑูุฏ ุฅูุดุงุก ุทุงุจูุฑ ุฌุฏูุฏ ูู ูู ูุฑุฉุ ุจู ูุฑูุฏ ุงูุฅุถุงูุฉ ุนูู ุทุงุจูุฑ ููุฌูุฏ (ูู ุญุงู ูุงูุช ูุฐู `SaveChanges` ุงูุซุงููุฉ ุฃู ุงูุซุงูุซุฉ ูู ููุณ ุงูุทูุจ).



```csharp
private void AddDomainEventsToOfflineProcessingQueue(List<IDomainEvent> domainEvents)
{
    // A. Try to get existing Queue from HttpContext.Items
    Queue<IDomainEvent> domainEventsQueue = _httpContextAccessor.HttpContext!.Items
        .TryGetValue("DomainEventsQueue", out var value) && value is Queue<IDomainEvent> existingQueue
            ? existingQueue
            : new Queue<IDomainEvent>();

    // B. Add new events to the Queue
    foreach (var domainEvent in domainEvents)
    {
        domainEventsQueue.Enqueue(domainEvent);
    }

    // C. Store back in HttpContext
    _httpContextAccessor.HttpContext.Items["DomainEventsQueue"] = domainEventsQueue;
}
```

---

## 4. Why This Works? ๐ง

1. **Linear Processing:** ุฅุฐุง ูุงู Event Handler ุจุงุณุชุฏุนุงุก `SaveChanges` ูุฑุฉ ุฃุฎุฑูุ ุณูุชู ุฅุถุงูุฉ ุงูุฃุญุฏุงุซ ุงูุฌุฏูุฏุฉ ุฅูู **ููุงูุฉ** ุงูุทุงุจูุฑุ ูุณุชุนุงูุฌ ุจุงูุชุฑุชูุจ.
    
2. **State Persistence:** ุงูู `HttpContext.Items` ูุจูู ุญูุงู ุทูุงู ูุชุฑุฉ ุงูุทูุจ (Request Lifetime)ุ ููุง ูุฌุนูู ููุงูุงู ูุซุงููุงู ูุชูุฑูุฑ ุงูุจูุงูุงุช ุจูู ุงูู DbContext ูุงูู Middleware.
    
3. **User Experience:** ุงููุณุชุฎุฏู ูุง ููุชุธุฑ ุชูููุฐ ุงูุฃุญุฏุงุซ ููุงุ ูู ููุชุธุฑ ููุท ุญูุธ ุงูุชุบููุฑ ุงูุฃููู. ุงูุชูููุฐ ุงููุนูู ููุฃุญุฏุงุซ ุณูุญุฏุซ ูู ุงูููุฏููููุฑ (ุงูุฐู ุณูุจููู ูู ุงูุฏูุนุฉ ุงููุงุฏูุฉ).
    

_ูู ุงูุฏูุนุฉ ุงููุงุฏูุฉุ ุณูุจูู ุงูู **Middleware** ุงูุฐู ุณูููู ุจุณุญุจ ูุฐุง ุงูุทุงุจูุฑ ูุชูููุฐูุ ูุณูุถูู ุทุจูุฉ ุฃูุงู ุฅุถุงููุฉ (Transaction Safety) ูุถูุงู ุนุฏู ุถูุงุน ุงูุจูุงูุงุช._

>[!Tip]
>END


---

# Deep Dive: Implementing True Eventual Consistency - Part 2

ูู ูุฐู ุงูุฏูุนุฉ ุงูุฃุฎูุฑุฉ ููุฐุง ุงููุณูุ ุณูููู ุจุฑุจุท ูู ุงููุทุน ุจุจุนุถูุง. ุณูุจูู ุงูู **Middleware** ุงูุฐู ูุนุชุจุฑ "ุงููุญุฑู" ููุฐู ุงูุนูููุฉุ ูุณูุถูู ุทุจูุฉ ุญูุงูุฉ (Transaction) ูุถูุงู ุนุฏู ุถูุงุน ุงูุจูุงูุงุช ุญุชู ูู ุญุฏุซุช ุงูุฃุฎุทุงุก ูู ุงูุฎูููุฉ.

---

## 1. The Middleware Implementation (The Engine) โ๏ธ

ูู ูุดุฑูุน **Infrastructure**ุ ุฏุงุฎู ูุฌูุฏ `Middleware`ุ ููุดุฆ `EventualConsistencyMiddleware`.

### ุงููููู ุงูุฃุณุงุณู

ูุฐุง ุงูููุฏููููุฑ ูุณุชูุจู `RequestDelegate` (ุงูุฐู ููุซู ุงูุฎุทูุฉ ุงูุชุงููุฉ ูู ุงูู Pipeline).



```csharp
public class EventualConsistencyMiddleware
{
    private readonly RequestDelegate _next;

    public EventualConsistencyMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task InvokeAsync(HttpContext context, IPublisher publisher, GymManagementDbContext dbContext)
    {
        // 1. Start a Transaction (Safety Net)
        // ูุจุฏุฃ ุชุฑุงูุฒูุดู ูุบุทู ุงูุทูุจ ุจุงููุงูู + ุงูุนูููุงุช ุงูุฎูููุฉ
        using var transaction = await dbContext.Database.BeginTransactionAsync();

        // 2. Add "OnCompleted" Callback
        // ูุฐุง ุงูููุฏ ุณูุนูู *ุจุนุฏ* ุฅุฑุณุงู ุงูุฑุฏ ูููุณุชุฎุฏู
        context.Response.OnCompleted(async () => 
        {
            try 
            {
                // A. Process the Queue
                if (context.Items.TryGetValue("DomainEventsQueue", out var value) && 
                    value is Queue<IDomainEvent> domainEventsQueue)
                {
                    while (domainEventsQueue.TryDequeue(out var domainEvent))
                    {
                        await publisher.Publish(domainEvent);
                    }
                }

                // B. Commit Transaction
                // ุฅุฐุง ูุฌุญุช ูู ุงูู Handlersุ ูุซุจุช ุงูุชุบููุฑุงุช ูู ุงูุฏุงุชุงุจูุณ
                await transaction.CommitAsync();
            }
            catch (Exception ex)
            {
                // C. Handle Failure
                // ุฅุฐุง ุญุฏุซ ุฎุทุฃ ููุงุ ุงููุณุชุฎุฏู ูุฏ ุงุณุชูู ุงูุฑุฏ "200 OK" ุจุงููุนู!
                // ุงูุญู: ุฅุฑุณุงู ุฅูููู ูููุณุชุฎุฏู ูุฎุจุฑู ุจูุดู ุงูุนูููุฉ
                // ุงูุชุฑุงูุฒูุดู ุณูููู ุจุนูู Rollback ุชููุงุฆูุงู ุนูุฏ ุงูู Dispose
            }
            finally 
            {
                await transaction.DisposeAsync();
            }
        });

        // 3. Continue the Request Pipeline
        // ุชูููุฐ ุงูู Command Handler ูุฅุฑุณุงู ุงูุฑุฏ ูููุณุชุฎุฏู
        await _next(context);
    }
}
```

### ุดุฑุญ ุงูููุงุท ุงูุญุฑุฌุฉ ๐ฆ

1. **`OnCompleted`:** ูุฐู ุงูุฏุงูุฉ ุชุถูู ุฃู ุงูููุฏ ุจุฏุงุฎููุง ูุง ูุนุทู ุงุณุชุฌุงุจุฉ ุงููุณุชุฎุฏู. ุงูุฑุฏ ูุฎุฑุฌุ ุซู ูุจุฏุฃ ุงูุชูููุฐ ููุง.
    
2. **`BeginTransaction`:** ูุถุนูุง ูู ุดูุก (ูุนุงูุฌุฉ ุงูุทูุจ ุงูุฃุตูู + ูุนุงูุฌุฉ ุงูุฃุญุฏุงุซ) ุฏุงุฎู ุชุฑุงูุฒูุดู ูุงุญุฏ.
    
    - **ููุงุฐุงุ** ุฅุฐุง ูุฌุญ ุญุฐู ุงูุฃุฏูู (ูู ุงูู Handler ุงูุฃุตูู) ููู ูุดู ุญุฐู ุงูุฌููุงุช (ูู ุงูุฎูููุฉ)ุ ูุง ูุฑูุฏ ุฃู ูุจูู ุงููุธุงู ูู ุญุงูุฉ ุบูุฑ ูุชุณูุฉ. ุงูู Transaction ุณูููู ุจู Rollback ููู ุดูุก.
        
    - **ุงูุชุญุฏู:** ุงููุณุชุฎุฏู ุญุตู ุนูู ุฑุฏ "ูุฌุงุญ"ุ ููู ุงูุฏุงุชุงุจูุณ ูุฏ ุชุชุฑุงุฌุน ุนู ุงูุญูุธ. ููุฐุง ุงูุชุฑุญ ุงููุญุงุถุฑ ุฅุฑุณุงู ุฅูููู ูู ุงูู `catch` ูุชูุจูู ุงููุณุชุฎุฏู.
        

---

## 2. Refactoring Registration (Clean Setup) ๐งน

ุจุฏูุงู ูู ุชุณุฌูู ุงูููุฏููููุฑ ูู `Program.cs` ูุจุงุดุฑุฉ (ููู ููู ูุฎุต ุงูู Presentation)ุ ููุถู ุฃู ุชููู ุงูู Infrastructure ูุณุคููุฉ ุนู ุฅุนุฏุงุฏุงุชูุง.

### 1. Create Request Pipeline Extension

ูู ูุดุฑูุน `Infrastructure`ุ ููุดุฆ ููู `RequestPipeline.cs`:



```csharp
public static class RequestPipeline
{
    public static IApplicationBuilder UseInfrastructureMiddleware(this IApplicationBuilder app)
    {
        app.UseMiddleware<EventualConsistencyMiddleware>();
        return app;
    }
}
```

### 2. Update Program.cs

ูู ูุดุฑูุน ุงูู Api:



```csharp
// ุจุฏูุงู ูู app.UseMiddleware<EventualConsistencyMiddleware>();
app.UseInfrastructureMiddleware();
```

---

## 3. The Final Flow: How it actually runs ๐โโ๏ธ

ููุชุฎูู ุงูุณููุงุฑูู ุงููุงูู ูุนูููุฉ **Delete Subscription** ุงูุขู:

1. **Request Starts:** ุงููุณุชุฎุฏู ูุฑุณู ุทูุจ ุงูุญุฐู.
    
2. **Middleware:** ูุจุฏุฃ ุงูุชุฑุงูุฒูุดู. ููุฑุฑ ุงูุทูุจ ููู Controller.
    
3. **Command Handler:**
    
    - ูุญุฐู ุงูุงุดุชุฑุงู ูู ุงูู Admin.
        
    - `SaveChanges` ุชุณุชุฏุนู -> ุชุนุชุฑุถ ุงูุฃุญุฏุงุซ -> ุชุฎุฒููุง ูู `HttpContext Queue`.
        
    - **ููุงุญุธุฉ:** ุงูุชุบููุฑุงุช ูู ุชุซุจุช ูู ุงูุฏุงุชุงุจูุณ ูุนููุงู ุจุนุฏ (ูุฃู ุงูุชุฑุงูุฒูุดู ูู ููุชูู).
        
4. **Response:** ุงูู Controller ูุฑุฌุน `204 No Content` ูููุณุชุฎุฏู. **ุงููุณุชุฎุฏู ุณุนูุฏ ููุดู.** ๐
    
5. **Background (OnCompleted):**
    
    - ุงูููุฏููููุฑ ูุณุญุจ ุงูุญุฏุซ `SubscriptionDeleted` ูู ุงูุทุงุจูุฑ.
        
    - ููุดุฑู ุนุจุฑ `MediatR`.
        
6. **Event Handlers:**
    
    - `GymsEventHandler` ูุนูู ููุญุฐู ุงูุฌููุงุช.
        
    - `SubscriptionsEventHandler` ูุนูู ููุญุฐู ุงูุงุดุชุฑุงู.
        
7. **Commit:**
    
    - ุงูููุฏููููุฑ ูุฑู ุฃู ูู ุดูุก ุชู ุจูุฌุงุญ.
        
    - ููุงุฏู `transaction.CommitAsync()`.
        
    - **ุงูุขู ููุท** ูุชู ุญุฐู ุงูุจูุงูุงุช ูุนููุงู ูู ุงูุฏุงุชุงุจูุณ.
        

---

## 4. Section Recap (ุฎูุงุตุฉ ุงูุณูุดู) ๐

ูู ูุฐุง ุงููุณู "ุงูุฏุณู"ุ ุชุนูููุง:

1. **Transactional vs Eventual:** ุงููุฑู ุจูู ุงูุงูุชุฒุงู ุงูููุฑู (ุงููู ุฃู ูุง ุดูุก) ูุงูุงูุชุฒุงู ุงููุงุญู (ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃุณุฑุน).
    
2. **Domain Events:** ููู ููุชูุท ุงูุฃุญุฏุงุซ ุงููููุฉ ุฏุงุฎู ุงูุฏูููู ุจุฏูุงู ูู ูุชุงุจุฉ ููุฏ "ุณุจุงุบูุชู" ูู ุงูู Handlers.
    
3. **The "Queue" Strategy:** ููู ุญูููุง ูุดููุฉ ุงูุชุธุงุฑ ุงููุณุชุฎุฏู ุนู ุทุฑูู ุชุฎุฒูู ุงูุฃุญุฏุงุซ ูุคูุชุงู ูู `HttpContext`.
    
4. **Resilience:** ููู ุงุณุชุฎุฏููุง ุงูู Transactions ูุญูุงูุฉ ุงูุจูุงูุงุช ุญุชู ูู ุงูุนูููุงุช ุงูุฎูููุฉ.
    

ุงูุขูุ ุงููุธุงู ุงูุฎุงุต ุจูุง:

- **Scalable:** ูู ุฌุฒุก ูุนูู ููุญุฏู.
    
- **Fast:** ุงููุณุชุฎุฏู ูุง ููุชุธุฑ ุงูุนูููุงุช ุงูุฌุงูุจูุฉ.
    
- **Clean:** ุงูู Domain Events ููุตููุฉ ุชูุงูุงู ุนู ุงูู Application Logic.
    

---

>[!Tip]
>END


