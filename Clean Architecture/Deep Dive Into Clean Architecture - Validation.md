

---

# Advanced Validation Strategies

ูุฐุง ุงููุณู ูู ุญุฌุฑ ุงูุฃุณุงุณ ูู ุจูุงุก ุชุทุจููุงุช ูููุฉ (Robust Applications). ุงูุชุฑููุฒ ููุง ููุณ ููุท ุนูู "ููู" ูุชุญูู ูู ุงูุจูุงูุงุชุ ุจู "ุฃูู" ูุถุน ููุฏ ุงูุชุญูู ูููุงุฐุงุ ูููู ููุตู ุจูู ุฃููุงุน ุงูุชุญูู ุงููุฎุชููุฉ ูุถูุงู **Clean Architecture** ุณูููุฉ.

## 1. The Two Main Types of Validation

ูู ุงูุจููุฉ ุงููุธููุฉ (Clean Architecture)ุ ูุฌุจ ุฃู ูููุฒ ุจูุถูุญ ุจูู ููุนูู ุฑุฆูุณููู ูู ุงูุชุญููุ ูุฃู ุงูุฎูุท ุจููููุง ูุคุฏู ุฅูู ููุฏ ูุชุดุงุจู ูุตุนุจ ุงูุตูุงูุฉ.

### A. Model Validation (ุชุญูู ุงููููุฐุฌ)

ูู ุงูุชุฃูุฏ ูู ุฃู ุงูุจูุงูุงุช ุงููุงุฏูุฉ ูู ุงููุณุชุฎุฏู "ุตุญูุญุฉ ุดูููุงู" ูุชูุงูู ุงููุนุงููุฑ ุงูุฃุณุงุณูุฉ ูุจู ุฃู ูุจุฏุฃ ุจูุนุงูุฌุชูุง.

* **ุงููุฏู:** ุงูุชุฃูุฏ ูู ุณูุงูุฉ ุงูุจูุงูุงุช (Data Integrity).
* **ุฃูุซูุฉ:**
* ุงุณู ุงูุฌูู ูุง ูุญุชูู ุนูู ุฑููุฒ ุฎุงุตุฉ.
* ุทูู ุงูุงุณู ูุง ููู ุนู 3 ุฃุญุฑู ููุง ูุฒูุฏ ุนู 1000.
* ุตูุบุฉ ุงูุฅูููู ุตุญูุญุฉ.


* **ุงูููุงู ุงูููุงุณุจ:**
* ูู ุทุจูุฉ **Presentation Layer**.
* ุฃู ูู ุจุฏุงูุฉ ุทุจูุฉ **Application Layer** (ูุจู ุงูุฏุฎูู ูู ุงูู Use Case Logic).



### B. Business Validation (ุชุญูู ููุงุนุฏ ุงูุนูู)

ูู ุงูุชุฃูุฏ ูู ุฃู ุงูุนูููุฉ ุงููุทููุจุฉ ูุง ุชุฎุงูู ููุงููู ุงูุนูู (Business Invariants) ุงูุฎุงุตุฉ ุจุงููุธุงู.

* **ุงููุฏู:** ุงูุญูุงุธ ุนูู ุงุชุณุงู ุญุงูุฉ ุงููุธุงู (System State Consistency).
* **ุฃูุซูุฉ:**
* ูุญุงููุฉ ุฅูุดุงุก ุฌูู ุฑุงุจุนุ ุจูููุง ููุน ุงูุงุดุชุฑุงู ูุณูุญ ุจู 3 ุฌููุงุช ููุท.
* ููุง ุงูุจูุงูุงุช "ุณูููุฉ ุดูููุงู" (ุงูุงุณู ุตุญูุญ)ุ ููู "ุงูุญุงูุฉ" ุชููุน ุงูุนูููุฉ.


* **ุงูููุงู ุงูููุงุณุจ:**
* ุญุตุฑุงู ูู ุทุจูุฉ **Domain Layer** (ูุฃู ููุงุนุฏ ุงูุจูุฒูุณ ุชุนูุด ููุงู).



---

## 2. The Blurry Line & The "Fail Fast" Principle

ุงูุญุฏ ุงููุงุตู ุจูู ุงูููุนูู ููุณ ุฏุงุฆูุงู ูุงุถุญุงู. ุงููุญุงุถุฑ ุทุฑุญ ูุซุงูุงู ููุถุญ ูุฐู ุงูุถุจุงุจูุฉ:
**ูุซุงู:** ูุฏููุง ูุงุฆู **User** ูุญุชูู ุนูู ุฎุงุตูุฉ **Age**ุ ูุงููุธุงู ูุดุชุฑุท ุฃู ูููู ุงูุนูุฑ **ุฃูุจุฑ ูู 18**.

* **ุงูุญูุฑุฉ:**
* ูู ูุฐุง **Model Validation**ุ (ูุฌุฑุฏ ุฑูู ูุฌุจ ุฃู ูููู ุถูู ูุทุงู ูุนูู).
* ุฃู ูู **Business Rule**ุ (ูุงููู ูููุน ุงููุงุตุฑูู ูู ุงูุชุณุฌูู).



### ุงุณุชุฑุงุชูุฌูุฉ "Fail Fast" (ุงููุดู ุงูุณุฑูุน)

ุนูู ุงูุฑุบู ูู ุฃู ุงูุชุญูู ูุฏ ูุจุฏู ููุงุนุฏุฉ ุจูุฒูุณุ ุฅูุง ุฃู ุงููุญุงุถุฑ ููุถู ูุจุฏุฃ **Fail Fast**:

> **ุงููุงุนุฏุฉ:** ุฅุฐุง ูุงู ุจุฅููุงูู ุงูุชุดุงู ุงูุฎุทุฃ ูุฑูุถู ูู ููุช ูุจูุฑุ ูุงูุนู ุฐูู ููุฑุงู ููุง ุชุถูุน ููุงุฑุฏ ุงููุนุงูุฌ (CPU Cycles) ูู ุชูุฑูุฑ ุงูุจูุงูุงุช ุนุจุฑ ุงูุทุจูุงุช ูุตููุงู ููุฏูููู.

* **ุงูุชุทุจูู:** ูููู ุจูุญุต ุงูุนูุฑ (> 18) ูู **Application/Presentation Layer** ููุฑูุถ ุงูุทูุจ ููุฑุงู.
* **ุงููุชูุฌุฉ:** ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃุณุฑุนุ ูุญูุงูุฉ ูููุธุงู ูู ูุนุงูุฌุฉ ุจูุงูุงุช ุบูุฑ ูููุฏุฉ.

---

## 3. Domain Model Integrity (Dual Validation)

ุฅุฐุง ูููุง ุจููู ุงูุชุญูู (ูุซู ุงูุนูุฑ > 18) ุฅูู ุงูุทุจูุงุช ุงูุนููุง (Upstream)ุ ูู ูุญุฐู ุงูุชุญูู ูู ุงูู **Domain Model**ุ
**ุงูุฌูุงุจ ุงููุงุทุน: ูุง.**

ูุฌุจ ุฃู ูุธู ุงูู Domain Model ูุทุจู ูุจุฏุฃ **Always Valid Domain Model**. ุงูุฏูููู ูุง ูุฌุจ ุฃู "ูุซู" ุจุฃู ุฃุญุฏุ ุญุชู ูู ูุงูุช ุงูุทุจูุงุช ุงูุชู ูุจูู ูุฏ ูุงูุช ุจุงููุญุต.

### ููู ูุชุนุงูู ุงูุฏูููู ูุน ุงูุจูุงูุงุช ุบูุฑ ุงูุตุงูุญุฉุ

ุจูุง ุฃููุง ูููุง ุจุงูุชุญูู ูุณุจูุงู ูู ุงูู Application Layerุ ูุฅู ูุตูู ุจูุงูุงุช ุฎุงุทุฆุฉ (ุนูุฑ 15 ูุซูุงู) ุฅูู ุงูุฏูููู ูุนุชุจุฑ **ุฃูุฑุงู ุบูุฑ ูุชููุน (Unexpected Behavior)** ุฃู Bug ูู ุงููุธุงู.

ูุฏููุง ุฎูุงุฑุงู ููุชุนุงูู ูุน ูุฐุง ูู ุงูุฏูููู:

#### ุงูุฎูุงุฑ 1: Throwing Exceptions (ุงูุฃูุซุฑ ุดููุนุงู ููุจุณุงุทุฉ)

ูู ุงูู Constructor ุงูุฎุงุต ุจุงูู User:

```csharp
public User(int age)
{
    if (age < 18) 
    {
        // ูุฑูู ุงุณุชุซูุงุก ูุฃู ูุฐุง ูุง ูุฌุจ ุฃู ูุญุฏุซ ุฃุจุฏุงู
        // Model Validation should have caught this!
        throw new InvalidOperationException("Age must be over 18");
    }
    Age = age;
}

```

* **ุงูุบุฑุถ:** ูุฐุง ุงูุฎุทุฃ ููุณ ูููุณุชุฎุฏูุ ุจู ูููุทูุฑ ููุฎุจุฑู ุฃู ููุงู ุฎููุงู ูู ุทุจูุงุช ุงูุชุญูู ุงูุนููุง.

#### ุงูุฎูุงุฑ 2: Value Objects (ููุญุงูุงุช ุงููุนูุฏุฉ)

ุจุฏูุงู ูู ุชูุฑูุฑ `int age`ุ ูููู ุจุฅูุดุงุก ูุงุฆู ูููุฉ (Value Object) ุงุณูู **UserAge**.

* ูุฐุง ุงููุงุฆู ูุง ูููู ุฅูุดุงุคู ุฅูุง ุฅุฐุง ูุงูุช ุงููููุฉ ุตุญูุญุฉ.
* ุงูุฏูููู ูุณุชูุจู `UserAge` ูู ุงููููุณุชุฑูุชูุฑ.
* ุจุฐูู ูุถูู ุงูุฏูููู ุฃู ุงูุจูุงูุงุช ุตุญูุญุฉ ุจูุฌุฑุฏ ุงุณุชูุงููุง.
* *ููุงุญุธุฉ:* ูุฐุง ูุฏ ูููู Overkill (ูุจุงูุบุฉ) ููุญุงูุงุช ุงูุจุณูุทุฉุ ููููู ููุชุงุฒ ูุญุงูุงุช ูุซู `Location` (ุฎุท ุทูู ูุนุฑุถ) ุฃู `Money`.

> **ุงูุฎูุงุตุฉ:** ุณูุญุฏุซ ุงูุชุญูู ูุฑุชูู (Twice). ูุฑุฉ ูู ุงูู Application ูุฅุฑุฌุงุน ุฑุณุงูุฉ ูุทููุฉ ูููุณุชุฎุฏูุ ููุฑุฉ ูู ุงูู Domain ูุถูุงู ุณูุงูุฉ ุงููุงุฆู (Throw Exception). ุงูุบุฑุถ ูุฎุชูู ูู ุงูุญุงูุชูู.

---

## 4. FluentValidation Library

ูุฅุฏุงุฑุฉ **Model Validation** ูู ุทุจูุฉ ุงูู Application ุจุดูู ูุธูู ููููุตู ุนู ุงูููุงุณุงุช ููุณูุงุ ุณูุณุชุฎุฏู ููุชุจุฉ **FluentValidation**.

### ูุง ูู FluentValidationุ

ููุชุจุฉ .NET ุดููุฑุฉ ุชุณูุญ ุจูุชุงุจุฉ ููุงุนุฏ ุงูุชุญูู ุจุทุฑููุฉ ุชุณูุณููุฉ (Fluent Interface) ุจุงุณุชุฎุฏุงู Lambda Expressionsุ ุจุฏูุงู ูู ุงุณุชุฎุฏุงู Attributes (ูุซู `[Required]`) ุงูุชู ุชููุซ ููุฏ ุงูู DTOs.

### ุดูู ุงูููุฏ (Concept):

ุจุฏูุงู ูู ูุชุงุจุฉ `if` statements ูุซูุฑุฉุ ููุชุจ ููุงุณ ูููุตู ููุชุญูู:

```csharp
public class CreateGymCommandValidator : AbstractValidator<CreateGymCommand> 
{
    public CreateGymCommandValidator() 
    {
        // ุชุนุฑูู ุงูููุงุนุฏ ุจุดูู ููุฑูุก ูุณูุณ
        RuleFor(x => x.Name)
            .NotEmpty()
            .MinimumLength(3)
            .MaximumLength(100);

        RuleFor(x => x.Age)
            .GreaterThanOrEqualTo(18)
            .WithMessage("You must be at least 18 years old.");
    }
}

```

### ุงุณุชุฑุงุชูุฌูุฉ ุงูุชุทุจูู ูู ูุดุฑูุนูุง

1. **ููู Command (ุฃู Query) ูุญุชุงุฌ ุชุญูู:** ุณููุดุฆ ููู **Validator** ุฎุงุต ุจู.
* ูุซุงู: `CreateGymCommand` ุณูููู ูู `CreateGymCommandValidator`.


2. **ุงูุชูููุช:** ุณูุชู ุชุดุบูู ูุฐุง ุงูู Validator **ูุจู** ุฃู ูุจุฏุฃ ุงูู Handler ุจุชูููุฐ ุงูููุฌูู.
3. **ุงููุชูุฌุฉ:**
* ุฅุฐุง ูุฌุญ ุงูุชุญูู: ูููู ุงูู Handler ุนููู.
* ุฅุฐุง ูุดู: ูุชู ุฅุฑุฌุงุน ูุงุฆูุฉ ุจุงูุฃุฎุทุงุก (ุชูุงุตูู ุงูุฎุทุฃุ ุงุณู ุงูุญููุ ุงููููุฉ ุงููุฑููุถุฉ) ูููุณุชุฎุฏู ููุฑุงูุ ููุง ูุชู ุงุณุชุฏุนุงุก ุงูู Handler.



ูุฐุง ุงูุฃุณููุจ ูุถูู ูุตู ููุฏ ุงูุชุญูู (Validation Logic) ุนู ููุฏ ุงูุจูุฒูุณ (Business Logic)ุ ููุง ูุฌุนู ุงููุธุงู ูุธููุงู ููุงุจูุงู ููุตูุงูุฉ ูุงูุงุฎุชุจุงุฑ.


---

# Deep Dive: FluentValidation & MediatR Pipelines


---

## 1. ุฅุนุฏุงุฏ FluentValidation

ููุจุฏุก ุจุชุทุจูู **Model Validation**ุ ูุญุชุงุฌ ุฃููุงู ูุฅุถุงูุฉ ุงูุฃุฏุงุฉ ุงููุงุฒูุฉ ูุทุจูุฉ ุงูุชุทุจูู ูุฏููุง.

### ุงูุชุซุจูุช (Installation)

ูุณุชุฎุฏู ุงูู CLI ูุฅุถุงูุฉ ุงูุญุฒูุฉ ุฅูู ูุดุฑูุน **Application Project**:

`dotnet add package FluentValidation`.

### ุฅูุดุงุก ูุฏูู (Creating a Validator)

ูููู ุจุฅูุดุงุก ููุงุณ Validator ููู ุฃูุฑ (Command) ูุฑูุฏ ุงูุชุญูู ููู. ูุฌุจ ุฃู ูุฑุซ ูุฐุง ุงูููุงุณ ูู `AbstractValidator<T>`ุ ุญูุซ `T` ูู ููุน ุงูู Command.

**ูุซุงู: `CreateGymCommandValidator`**

ูุฐุง ุงูุฃูุฑ ูุณุชูุจู ุญุงููุงู `Name` ู `SubscriptionId`. ูุฑูุฏ ุงูุชุญูู ูู ุตุญุฉ ุญูู `Name`.



```C#
public class CreateGymCommandValidator : AbstractValidator<CreateGymCommand>
{
    public CreateGymCommandValidator()
    {
        // ุชุนุฑูู ุงูููุงุนุฏ
        RuleFor(x => x.Name)
            .MinimumLength(3)
            .MaximumLength(100);
    }
}
```

- **RuleFor:** ุชุญุฏุฏ ุงูุฎุงุตูุฉ ุงูุชู ูุฑูุฏ ุงูุชุญูู ูููุง.
    
- **ุณูุณูุฉ ุงูููุงุนุฏ (Chaining):** ูููููุง ุฏูุฌ ุนุฏุฉ ุดุฑูุท ูุซู `MinimumLength` ู `MaximumLength` ูุชุญุฏูุฏ ุงููุนุงููุฑ ุจุฏูุฉ.
    

---

## 2. ุงูุชูููุฐ "ุงูุจุฏุงุฆู" (ุงูุชุญูู ุงููุฏูู)

ูู ุงูุจุฏุงูุฉุ ูุฏ ูููู ูุงุณุชุฎุฏุงู ูุฐุง ุงูู Validator ูุจุงุดุฑุฉ ุฏุงุฎู ุงูู **Command Handler**. ูุฑุบู ุฃู ูุฐุง ูุนููุ ุฅูุง ุฃูู ูุถูู ููุฏุงู ููุฑุฑุงู (Boilerplate) ููุฌุนู ุงูู Handler ุบูุฑ ูุธูู.

### ููู ูุจุฏู ุงูููุฏ (ุงูุทุฑููุฉ ุบูุฑ ุงููุซุงููุฉ)

ุฏุงุฎู `CreateGymCommandHandler`:

1. **ุฅูุดุงุก ูุณุฎุฉ:** `var validator = new CreateGymCommandValidator();`.
    
2. **ุงูุชุญูู:** ุงุณุชุฏุนุงุก `validator.ValidateAsync(command)`. ูุฐุง ูุฑุฌุน ูุงุฆู `ValidationResult`.
    
3. **ูุญุต ุงูุตูุงุญูุฉ:** ุงูุชุญูู ูู `validationResult.IsValid`.
    
4. **ุชุญููู ุงูุฃุฎุทุงุก:** ุฅุฐุง ูุงู ุบูุฑ ุตุงูุญุ ูููู ุจุนูู Loop ุนูู `validationResult.Errors` ูุชุญููููุง ุฅูู ููุน `Error` ุงูุฎุงุต ุจูุธุงููุง.
    

### ูุงุฆู ูุชูุฌุฉ ุงูุชุญูู (The ValidationResult Object)

ุนูุฏูุง ููุดู ุงูุชุญููุ ูุญุชูู `ValidationResult` ุนูู ูุงุฆูุฉ ุจุงูุฅุฎูุงูุงุช. ูู ุฅุฎูุงู ูุญุชูู ุนูู:

- **PropertyName:** ุงุณู ุงูุญูู ุงูุฐู ูุดู (ูุซูุงู "Name").
    
- **ErrorMessage:** ุฑุณุงูุฉ ูุตููุฉ ุชููุฏูุง ุงูููุชุจุฉ (ูุซูุงู "The length of 'Name' must be at least 3 characters...").
    

**ููุฏ ุงูุชุญููู ุงููุฏูู:**



```C#
if (!validationResult.IsValid)
{
    // ุชุญููู ูู ุฎุทุฃ ูู FluentValidation ุฅูู Error ุฎุงุต ุจูุธุงููุง
    var errors = validationResult.Errors
        .ConvertAll(validationFailure => Error.Validation(
            code: validationFailure.PropertyName,
            description: validationFailure.ErrorMessage));

    return errors;
}
```

_ูุฐู ุงูุทุฑููุฉ ุชุชุทูุจ ูุชุงุจุฉ ููุณ ุงูููุฏ ูู **ูู Handler**ุ ููู ุฃูุฑ ุณูุก ุฌุฏุงู ููุตูุงูุฉ._

---

## 3. ุณููููุงุช ุฎุท ุงูุฃูุงุจูุจ (MediatR Pipeline Behaviors)

ูุญู ูุดููุฉ ุชูุฑุงุฑ ุงูููุฏุ ูุณุชุฎุฏู ููุฒุฉ ูููุฉ ูู MediatR ุชุณูู **Pipeline Behaviors**.

### ุงูููููู (Concept)

ููุท **Mediator Design Pattern** ููุตู ุจูู ุงูููููุงุช. ุงููููู A ูุฑุณู ุจูุงูุงุช ูููุณูุท (Mediator)ุ ูุงูุฐู ูุฑุณููุง ูููููู C (ุงูู Handler).

**Pipeline Behaviors** ุชุณูุญ ููุง ุจุญูู ููุทู ุจุฑูุฌู **ุจูู** ุงููุณูุท ูุจูู ุงููููู C. ูุฐุง ูุดุจู ุชูุงูุงู ููุฑุฉ **Middleware** ูู ASP.NET Core.

### ููู ุชุนููุ

1. **ูุง ูุจู ุงููุนุงูุฌุฉ (Pre-processing):** ูุชู ุชูููุฐ ุงูููุฏ ูุจู ุงููุตูู ููู Handler.
    
2. **ุงูุชุงูู (Next):** ุงูุณููู ูุณุชุฏุนู `next()`ุ ููุง ูููู ุงูุชูููุฐ ููุณููู ุงูุชุงูู ุฃู ููู Handler ุงูููุงุฆู.
    
3. **ูุง ุจุนุฏ ุงููุนุงูุฌุฉ (Post-processing):** ูุชู ุชูููุฐ ุงูููุฏ ุจุนุฏ ุนูุฏุฉ ุงูู Handler (ูู ุทุฑูู ุงูุนูุฏุฉ).
    

### ุงูุชุณุฌูู (Registration)

ูุงุณุชุฎุฏุงู ุฃู Behaviorุ ูุฌุจ ุชุณุฌููู ูู ุญุงููุฉ **Dependency Injection (DI)**:

`services.AddScoped(typeof(IPipelineBehavior<,>), typeof(MyBehavior<,>));`.

---

## 4. ุชูููุฐ ุณููู ุชุญูู ูุญุฏุฏ (Specific Validation Behavior)

ูููููุง ููู ููุฏ ุงูุชุญูู ุงููุฏูู ูู ุงูู Handler ููุถุนู ูู Behavior ุฎุงุต.

### ุฅูุดุงุก ุงูุณููู (Creating the Behavior)

ูููู ุจุฅูุดุงุก ููุงุณ `CreateGymCommandBehavior` ุงูุฐู ูููุฐ ุงููุงุฌูุฉ `IPipelineBehavior<CreateGymCommand, ErrorOr<Gym>>`.



```C#
public class CreateGymCommandBehavior : IPipelineBehavior<CreateGymCommand, ErrorOr<Gym>>
{
    private readonly IValidator<CreateGymCommand> _validator;

    public CreateGymCommandBehavior(IValidator<CreateGymCommand> validator)
    {
        _validator = validator; // ุญูู ุงููุฏูู
    }

    public async Task<ErrorOr<Gym>> Handle(
        CreateGymCommand request, 
        RequestHandlerDelegate<ErrorOr<Gym>> next, 
        CancellationToken cancellationToken)
    {
        // 1. ุชูููุฐ ููุทู ุงูุชุญูู ููุง (ููุณ ุงูููุฏ ุงูุณุงุจู)
        var validationResult = await _validator.ValidateAsync(request, cancellationToken);

        if (!validationResult.IsValid)
        {
            // ุฅุฑุฌุงุน ุงูุฃุฎุทุงุก ููุฑุงูุ ููุทุน ุงูุฏุงุฆุฑุฉ (Short-Circuiting)
            // ูู ูุชู ุงุณุชุฏุนุงุก ุงูู Handler ุฃุจุฏุงู
            return validationResult.Errors
                .ConvertAll(validationFailure => Error.Validation(
                    code: validationFailure.PropertyName,
                    description: validationFailure.ErrorMessage));
        }

        // 2. ุฅุฐุง ูุงู ุตุงูุญุงูุ ุงุณุชุฏุนู ุงูุฎุทูุฉ ุงูุชุงููุฉ (The Handler)
        return await next(); 
    }
}
```

**ููุทุฉ ุฌููุฑูุฉ:** ุฅุฐุง ูุงูุช ุงูุจูุงูุงุช ุบูุฑ ุตุงูุญุฉุ ูููู ุจุฅุฑุฌุงุน ุงูุฃุฎุทุงุก ููุฑุงู. ูุญู **ูุง ูุณุชุฏุนู** `next()`ุ ููุง ูููุน ุงูู Handler ูู ุงูุนูู ููุงุฆูุงู.

---

## 5. ุงูุงูุชูุงูุงุช ุงููุชูุงุทุนุฉ ูุงูุณููููุงุช ุงูุนุงูุฉ (Generic Behaviors)

ุนูู ุงูุฑุบู ูู ุฃู ุงูุณููู ุงููุญุฏุฏ ูุนููุ ุฅูุง ุฃูู ูุง ูุฒุงู ูุชุทูุจ ุฅูุดุงุก ููุงุณ Behavior ูุฑูุฏ ููู Command (`CreateGymBehavior`, `CreateSubscriptionBehavior`...ุงูุฎ). ูุฐุง ูุง ูุฒุงู ูุนุชุจุฑ ููุฏุงู ููุฑุฑุงู (Boilerplate).

### ุงูุญู: ุงูุณููููุงุช ุงูุนุงูุฉ (Generic Behaviors)

ูููููุง ุชุนุฑูู Behavior ุจุงุณุชุฎุฏุงู **Open Generics** ููุชุนุงูู ูุน ุงูุชุญูู ูุฃู ุทูุจ ูู ููุน `TRequest`.

**ุงูููููู:**

ุจุฏูุงู ูู ุฑุจุท ุงูุณููู ุจู `CreateGymCommand` ููุทุ ูุนุฑููู ูู `<TRequest, TResponse>`.

ูุฐุง ูุณูุญ ููุง ุจุชูููุฐ **Cross-Cutting Concerns** (ููู ุงูุฃููุฑ ุงูุชู ุชูุทุจู ุนูู ุงููุธุงู ุจุฃูููู ูุซู ุงูุชุณุฌูู Logging ุฃู ุงูุชุญูู Validation) ูู ููุงู ูุงุญุฏ ูุฑูุฒู.

### ุชุณุฌูู ุงูุณููููุงุช ุงูุนุงูุฉ

ูุณุฌู ูุฐุง ุจุงุณุชุฎุฏุงู `AddOpenBehavior`:

`services.AddOpenBehavior(typeof(ValidationBehavior<,>));`.

- ุนูุฏูุง ูุนุงูุฌ MediatR ุฃู ุทูุจุ ูุฅูู ูุจุญุซ ุนู ูู ุงูู Behaviors ุงููุชูุงููุฉ ูุน ููุน ุงูุทูุจ.
    
- ุฅุฐุง ุณุฌููุง `ValidationBehavior` ุนุงูุ ุณูููู MediatR ุจุชุทุจููู ุชููุงุฆูุงู ุนูู ูู ุงูุทูุจุงุช ูู ุงููุธุงู.
    

---

# Deep Dive: Generic Validation Pipeline & Domain Validation



---

## 1. ุชูููุฐ ุณููู ุงูุชุญูู ุงูุนุงู (Generic Validation Behavior)

ุงููุฏู ูู ุฅูุดุงุก Behavior ูุงุญุฏ ูุนูู ูุน ุฃู ุทูุจ (`TRequest`) ูุฃู ุงุณุชุฌุงุจุฉ (`TResponse`)ุ ุจุดุฑุท ุฃู ุชุชูุงูู ูุน ูุนุงููุฑ ูุนููุฉ.

### ุงูุชุญุฏู ุงูุชููู: ุฅุฑุฌุงุน ุงูุฃุฎุทุงุก ุจุดูู ุนุงู ๐งฉ

ุงููุดููุฉ ุชููู ูู ุฃููุง ูุฑูุฏ ุชุญููู ุฃุฎุทุงุก FluentValidation (ูุงุฆูุฉ ุฃุฎุทุงุก) ุฅูู ููุน ุงูุงุณุชุฌุงุจุฉ ุงูุฎุงุต ุจูุง (`ErrorOr`) ุจุดูู ุฏููุงููููุ ุฏูู ูุนุฑูุฉ ุงูููุน ุงููุญุฏุฏ ุฃุซูุงุก ููุช ุงูุชุฑุฌูุฉ (Compile Time).

### ุฎุทูุงุช ุงูุชูููุฐ

#### ุฃ. ุชุนุฑูู ุงูุณููู (Define the Behavior)

ูููู ุจุฅูุดุงุก `ValidationBehavior<TRequest, TResponse>` ูุฑุซ ูู `IPipelineBehavior`.

**ุงููููุฏ (Constraints):**

- `TRequest` ูุฌุจ ุฃู ูููู `IRequest<TResponse>`.
    
- `TResponse` ูุฌุจ ุฃู ูุทุจู ุงููุงุฌูุฉ `IErrorOr`.
    


```C#

public class ValidationBehavior<TRequest, TResponse> 
    : IPipelineBehavior<TRequest, TResponse>
    where TRequest : IRequest<TResponse>
    where TResponse : IErrorOr // ููุฏ ููู ููุชุฃูุฏ ูู ุฃููุง ูุณุชุทูุน ุฅุฑุฌุงุน ุฃุฎุทุงุก
{
    private readonly IValidator<TRequest>? _validator; // ูุฏ ูููู null!

    // ุญูู ุงููุฏูู (ุงุฎุชูุงุฑู)
    public ValidationBehavior(IValidator<TRequest>? validator = null)
    {
        _validator = validator;
    }

    public async Task<TResponse> Handle(...)
    {
        // 1. ุงูุชุญูู ูู ูุฌูุฏ validator ููุฐุง ุงูุทูุจ
        if (_validator is null)
        {
            return await next(); // ุฅุฐุง ูู ููุฌุฏ ูุฏููุ ุฃููู ุงููุณุงุฑ
        }

        // 2. ุชูููุฐ ุงูุชุญูู
        var validationResult = await _validator.ValidateAsync(request, cancellationToken);

        if (validationResult.IsValid)
        {
            return await next();
        }

        // 3. ุชุญููู ุงูุฃุฎุทุงุก
        var errors = validationResult.Errors
            .ConvertAll(error => Error.Validation(
                code: error.PropertyName,
                description: error.ErrorMessage));

        // 4. ุงูุญููุฉ ุงูุฏููุงููููุฉ ูุฅุฑุฌุงุน ุงููุชูุฌุฉ (The Magic Trick) ๐ฉ
        // ุจูุง ุฃู ุงููุชุฑุฌู (Compiler) ูุง ูุนุฑู ููููุฉ ุชุญููู List<Error> ุฅูู TResponse ุจุดูู ูุจุงุดุฑ
        // ูุณุชุฎุฏู dynamic ููุนุชูุฏ ุนูู ุงูุชุญููู ุงูุถููู (Implicit Conversion) ุงูููุฌูุฏ ูู ErrorOr ุฃุซูุงุก ุงูุชุดุบูู
        return (dynamic)errors; 
    }
}
```

#### ุจ. ุชุณุฌูู ุงููุฏููุงุช ุชููุงุฆูุงู (Auto-Registration)

ุจุฏูุงู ูู ุชุณุฌูู ูู Validator ูุฏููุงูุ ูุณุชุฎุฏู ุญุฒูุฉ `FluentValidation.AspNetCore` ูุนูู ูุณุญ (Scan) ูููุดุฑูุน ูุชุณุฌูููู ุฌููุนุงู ุฏูุนุฉ ูุงุญุฏุฉ.

ูู `DependencyInjection.cs`:



```C#
services.AddValidatorsFromAssemblyContaining<DependencyInjection>(); // ููุณุญ ูู ุงูู validators ูู ุงููุดุฑูุน
```

ูุฐุง ูุถูู ุฃู ุฃู ููุงุณ ูุฑุซ ูู `AbstractValidator<T>` ุณูุชู ุชุณุฌููู ุชููุงุฆูุงู ูู `IValidator<T>`.

#### ุฌ. ุชุณุฌูู ุงูุณููู ุงูุนุงู (Open Behavior Registration)

ุฃุฎูุฑุงูุ ูุณุฌู ุงูู Generic Behavior ูู MediatR:



```C#
services.AddOpenBehavior(typeof(ValidationBehavior<,>));
```

ุงูุขูุ ุฃู Command ูุชู ุฅุฑุณุงูู ุนุจุฑ MediatR ุณููุฑ ุชููุงุฆูุงู ุนุจุฑ ูุฐุง ุงูุฃูุจูุจ (Pipeline). ุฅุฐุง ูุงู ูู Validatorุ ุณูุชู ูุญุตู.

---

## 2. ุงูุชุญูู ูู ุทุจูุฉ ุงููุฌุงู (Domain Layer Validation)

ุงูุขู ููุชูู ููููุน ุงูุซุงูู ูู ุงูุชุญูู: **Business Rules**.

### ููู ูููุฒ ููุงุนุฏ ุงูุจูุฒูุณุ

ุงููุญุงุถุฑ ูุฏู ูุงุนุฏุฉ ุฐูุจูุฉ ููุชูููุฒ ุจูู **Model Validation** ู **Business Validation**:

> **Business Validation ูุนุชูุฏ ุบุงูุจุงู ุนูู ุงูุญุงูุฉ (State-Dependent).**

**ููุงุฑูุฉ:**

- **ุงูุชุญูู ูู ุงูุนูุฑ (> 18):** ูููุฉ ุซุงุจุชุฉ (Static). ูููู ูุญุตูุง ูู ุฃู ููุงู. -> **Model Validation**.
    
- **ุงูุชุญูู ูู ุนุฏุฏ ุงูุบุฑู (Max Rooms):** ูุญุชุงุฌ ููุนุฑูุฉ ุนุฏุฏ ุงูุบุฑู _ุงูุญุงูู_ุ ูููุน ุงูุงุดุชุฑุงู _ุงูุญุงูู_. ุงููุฑุงุฑ ูุนุชูุฏ ุนูู ุญุงูุฉ ุงููุธุงู ูู ูุฐู ุงููุญุธุฉ. -> **Business Validation**.
    

### ุงูุชูููุฐ ูู ุงูููุฏ

ูุถุน ูุฐุง ุงูููุทู ุฏุงุฎู ุงูู Domain Object ููุณู ูุถูุงู ุญูุงูุฉ ุงูุญุงูุฉ (Encapsulation).

**ูุซุงู: `AddGym` ูู `Subscription`:**



```C#
public ErrorOr<Success> AddGym(Gym gym)
{
    // ูุญุต ูุนุชูุฏ ุนูู ุงูุญุงูุฉ (State)
    if (_gymIds.Count >= _maxGyms)
    {
        return SubscriptionErrors.CannotHaveMoreGymsThanSubscriptionAllows;
    }

    _gymIds.Add(gym.Id);
    return Result.Success;
}
```

### ุงูุฃุฎุทุงุก ุงููุญุฏุฏุฉ ูุณุจูุงู (Predefined Errors)

ููุถู ุชุฌููุน ุฃุฎุทุงุก ุงูุฏูููู ูู ูููุงุช ุซุงุจุชุฉ (`Errors.Subscription`) ุจุฏูุงู ูู ูุชุงุจุชูุง ููุตูุต ุนุดูุงุฆูุฉุ ููุณูู ุชุชุจุนูุง ูุตูุงูุชูุง.

---

## 3. ููุฎุต ุงููุณู (Recap)

ุจูุฐุง ูููู ูุฏ ุบุทููุง ุงุณุชุฑุงุชูุฌูุฉ ุงูุชุญูู ุงูุดุงููุฉ ูู **Clean Architecture**:

1. **Model Validation:**
    
    - ุงูููุงู: **Application Layer** (ุจุงุณุชุฎุฏุงู FluentValidation).
        
    - ุงูุขููุฉ: **Generic Pipeline Behavior** ููุญุต ุงูุทูุจุงุช ุชููุงุฆูุงู ูุจู ูุตูููุง ููู Handler.
        
    - ุงููุชูุฌุฉ: ุฅุฑุฌุงุน **400 Bad Request** ูุน ุชูุงุตูู ุงูุญููู ุงูุฎุงุทุฆุฉ.
        
2. **Business Validation:**
    
    - ุงูููุงู: **Domain Layer**.
        
    - ุงููุนูุงุฑ: ูุนุชูุฏ ุนูู ุญุงูุฉ ุงููุธุงู (State) ููุฑุงุฑุงุช ุงูุจูุฒูุณ ุงููุชุบูุฑุฉ.
        
    - ุงููุชูุฌุฉ: ุฅุฑุฌุงุน **Conflict** ุฃู ุฎุทุฃ ุจูุฒูุณ ูุญุฏุฏ.
        
3. **ุงูุชุฏุงุฎู (Overlap):**
    
    - ุฃุญูุงูุงู ูููู ุจุงูุชุญูู ูุฑุชูู (ูุฑุฉ ูู ุงูู App ููุฑุฉ ูู ุงูู Domain).
        
    - ุงููุดู ูู ุงูู App ูุชููุน (User Error).
        
    - ุงููุดู ูู ุงูู Domain (ุจุนุฏ ุชุฌุงูุฒ ุงูู App) ูุนุชุจุฑ ุบูุฑ ูุชููุน (System Inconsistency) ููุฏ ููุฌุจ ุฑูู Exception.
        

---

